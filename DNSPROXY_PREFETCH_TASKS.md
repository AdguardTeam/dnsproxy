# DNSProxy 预取功能实施任务清单

## 项目概述

将 dnsproxy 的乐观缓存机制从**被动刷新**改为**主动预取**，在缓存过期前主动刷新，确保缓存始终新鲜。

### 核心变化
- **旧逻辑（被动）**：用户查询 → 缓存过期 → 返回旧缓存 → 后台刷新
- **新逻辑（主动）**：用户查询 → 域名加入缓存 → TTL-5秒时主动刷新 → 缓存始终新鲜

## 当前状态

### ✅ 已完成（第一阶段）
1. 复制预取代码文件到 proxy/ 目录
   - ✅ `proxy/prefetch_queue.go` - 优先级队列实现
   - ✅ `proxy/prefetch_manager.go` - 预取管理器实现

2. 修改现有文件以集成预取功能
   - ✅ `proxy/config.go` - 添加 `Prefetch *PrefetchConfig` 配置字段
   - ✅ `proxy/cache.go` - 添加预取管理器字段和 `SetPrefetchManager` 方法
   - ✅ `proxy/cache.go` - 在 `set()` 方法中添加预取队列钩子
   - ✅ `proxy/proxy.go` - 添加 `prefetchManager` 字段
   - ✅ `proxy/proxy.go` - 在 `New()` 中初始化预取管理器
   - ✅ `proxy/proxy.go` - 在 `Start()` 中启动预取管理器
   - ✅ `proxy/proxy.go` - 在 `Shutdown()` 中停止预取管理器
   - ✅ `proxy/proxy.go` - 添加 `GetPrefetchMetrics()` 方法

3. 代码编译验证
   - ✅ 修复 dns64.go 中的类型错误
   - ✅ 修复 prefetch_manager.go 中未使用的导入
   - ✅ 成功编译 `go build ./proxy`

## 待完成任务

### 阶段 2：测试和验证（预计 1-2 天）

#### 2.1 单元测试
- [ ] **任务 2.1.1**：创建 `proxy/prefetch_queue_test.go`
  - 测试优先级队列的基本操作（Push, Pop, PopN）
  - 测试优先级排序是否正确
  - 测试并发安全性
  - 测试边界条件（空队列、满队列）

- [ ] **任务 2.1.2**：创建 `proxy/prefetch_manager_test.go`
  - 测试预取管理器的初始化
  - 测试 Add 方法添加域名到队列
  - 测试批量处理逻辑
  - 测试刷新逻辑
  - 测试统计指标收集

- [ ] **任务 2.1.3**：创建 `proxy/cache_prefetch_test.go`
  - 测试缓存与预取管理器的集成
  - 测试 SetPrefetchManager 方法
  - 测试缓存 set 时是否正确加入预取队列
  - 测试预取刷新后缓存是否更新

#### 2.2 集成测试
- [ ] **任务 2.2.1**：创建端到端测试
  - 启动完整的 proxy 实例
  - 配置启用预取功能
  - 发送 DNS 查询
  - 验证域名加入预取队列
  - 等待预取刷新触发
  - 验证缓存被更新

- [ ] **任务 2.2.2**：测试配置选项
  - 测试禁用预取时的行为
  - 测试不同的 BatchSize 配置
  - 测试不同的 CheckInterval 配置
  - 测试不同的 RefreshBefore 配置

#### 2.3 性能测试
- [ ] **任务 2.3.1**：压力测试
  - 测试大量域名场景（1000+ 域名）
  - 测试高并发查询
  - 测试内存使用情况
  - 测试 CPU 使用情况

- [ ] **任务 2.3.2**：基准测试
  - 创建 benchmark 测试
  - 对比启用/禁用预取的性能差异
  - 测量预取刷新的延迟

### 阶段 3：文档和示例（预计 0.5-1 天）

#### 3.1 代码文档
- [ ] **任务 3.1.1**：完善代码注释
  - 确保所有公开函数都有完整的 godoc 注释
  - 添加使用示例
  - 说明配置参数的含义和默认值

#### 3.2 使用文档
- [ ] **任务 3.2.1**：更新 README.md
  - 添加预取功能说明
  - 添加配置示例
  - 说明工作原理
  - 列出优势和注意事项

- [ ] **任务 3.2.2**：创建配置示例
  - 创建 `config.example.yaml` 展示预取配置
  - 提供不同场景的配置建议

#### 3.3 迁移指南
- [ ] **任务 3.3.1**：更新 DNSPROXY_MIGRATION_GUIDE.md
  - 添加测试验证步骤
  - 添加性能对比数据
  - 添加故障排查指南

### 阶段 4：优化和完善（预计 1-2 天）

#### 4.1 性能优化
- [ ] **任务 4.1.1**：内存优化
  - 实现对象池减少 GC 压力
  - 限制队列最大大小
  - 定期清理过期项

- [ ] **任务 4.1.2**：并发控制优化
  - 实现 worker pool 限制并发刷新数量
  - 添加超时控制
  - 优化锁的使用

#### 4.2 监控和调试
- [ ] **任务 4.2.1**：增强日志记录
  - 添加详细的调试日志
  - 定期输出统计信息
  - 记录异常情况

- [ ] **任务 4.2.2**：添加指标收集
  - 实现详细的 metrics 结构
  - 添加平均刷新时间统计
  - 添加成功率统计

#### 4.3 错误处理
- [ ] **任务 4.3.1**：完善错误处理
  - 处理上游查询失败
  - 处理网络超时
  - 处理队列满的情况
  - 添加重试机制

### 阶段 5：与 AdGuardHome 集成（可选）

如果需要在 AdGuardHome 中使用这个功能：

- [ ] **任务 5.1**：更新 AdGuardHome 的 go.mod
  - 指向修改后的 dnsproxy fork
  - 或者发布新版本后更新依赖

- [ ] **任务 5.2**：配置 AdGuardHome
  - 在 AdGuardHome 配置中启用 dnsproxy 预取
  - 移除旧的 AdGuardHome 层面预取代码（如果存在）

- [ ] **任务 5.3**：测试集成
  - 在 AdGuardHome 中测试预取功能
  - 验证统计不包含预取请求
  - 验证性能改进

## 优先级建议

### 高优先级（必须完成）
1. ✅ 基础代码集成（已完成）
2. 单元测试（任务 2.1）
3. 基本集成测试（任务 2.2.1）
4. 基础文档（任务 3.2.1）

### 中优先级（建议完成）
1. 完整集成测试（任务 2.2.2）
2. 性能测试（任务 2.3）
3. 完善文档（任务 3.1, 3.2.2, 3.3）
4. 基础优化（任务 4.1）

### 低优先级（可选）
1. 高级优化（任务 4.2, 4.3）
2. AdGuardHome 集成（任务 5）

## 时间估算

- **阶段 2（测试）**：1-2 天
- **阶段 3（文档）**：0.5-1 天
- **阶段 4（优化）**：1-2 天
- **阶段 5（集成）**：1-2 天（可选）

**总计**：3-7 天（不包括可选的 AdGuardHome 集成）

## 验证清单

在完成所有任务后，确保：

- [ ] 所有单元测试通过
- [ ] 集成测试通过
- [ ] 性能测试满足要求
- [ ] 代码编译无警告
- [ ] 文档完整且准确
- [ ] 配置示例可用
- [ ] 日志输出清晰
- [ ] 错误处理完善
- [ ] 内存使用合理
- [ ] 并发安全

## 下一步行动

请确认以上任务清单，我将按照优先级开始执行：

1. **首先**：创建单元测试（任务 2.1）
2. **然后**：创建集成测试（任务 2.2.1）
3. **接着**：更新文档（任务 3.2.1）
4. **最后**：根据需要进行优化和完善

是否开始执行？或者需要调整任务优先级？
