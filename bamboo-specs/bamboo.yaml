---
'version': 2
'plan':
    'project-key': 'GO'
    'key': 'DNSPROXY'
    'name': 'dnsproxy - Build and run tests'
'variables':
    # This variable is used to override Docker caching, for example to rerun a
    # flaky test suite.
    'cacheBuster': '0'
    'dockerFpm': 'alanfranz/fpm-within-docker:ubuntu-bionic'
    # When there is a patch release of Go available, set this property to an
    # exact patch version as opposed to a minor one to make sure that this exact
    # version is actually used and not whatever the docker daemon on the CI has
    # cached a few months ago.
    'dockerGo': 'adguard/go-builder:1.25.5--1'
    'maintainer': 'Adguard Go Team'
    'name': 'dnsproxy'

'stages':
  - 'Test':
      'manual': false
      'final': false
      'jobs':
        - 'Test'

'Test':
    'final-tasks':
      - 'test-parser':
          # The default pattern, '**/test-reports/*.xml', works, so don't set
          # the test-results property.
          'type': 'junit'
          'ignore-time': true
      - 'clean'
    'key': 'TEST'
    'other':
        'clean-working-dir': true
    'tasks':
      - 'checkout':
            'force-clean-build': true
      - 'script':
            'interpreter': 'SHELL'
            # Projects that have go-bench and/or go-fuzz targets should add them
            # here as well.
            'scripts':
              - |
                #!/bin/sh

                set -e -f -u -x

                docker info

                docker build \
                    --build-arg "BASE_IMAGE=${bamboo_dockerGo}" \
                    --build-arg "CACHE_BUSTER=${bamboo_cacheBuster}" \
                    --output '.' \
                    --progress 'plain' \
                    --target 'tester-exporter' \
                    -f ./docker/ci.Dockerfile \
                    .

                  exit_code="$(cat ./test-reports/test-exit-code.txt)"
                  readonly exit_code

                  exit "$exit_code"

'branches':
    'create': 'for-pull-request'
    'delete':
        'after-deleted-days': 1
        'after-inactive-days': 5
    'link-to-jira': true

'notifications':
  - 'events':
      - 'plan-status-changed'
    'recipients':
      - 'webhook':
            'name': 'Build webhook'
            'url': 'http://prod.jirahub.service.eu.consul/v1/webhook/bamboo'

'labels': []

'other':
    'concurrent-build-plugin': 'system-default'
